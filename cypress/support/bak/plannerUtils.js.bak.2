/**
 * Cypress Utilities for Planner Tests
 */

// Essential constants only
const PLANNER_CONSTANTS = {
  SELECTION_WAIT: 250,
  CALCULATOR_WAIT: 1000,
  TEAM_ACTION_WAIT: 500,
  FIRST_TEAM_MEMBER_COLUMN: 10,
  PRICE_COLUMN: 5,
  MAX_TEAM_MEMBERS: 20,
};

// Extract price from table row - SIMPLIFIED: One return path, proper chaining
const extractPriceFromRow = (rowIndex) => {
  return cy
    .get(`#table-row-${rowIndex}`)
    .find(`[aria-colindex="${PLANNER_CONSTANTS.PRICE_COLUMN}"]`)
    .invoke("text")
    .then((priceText) => {
      const cleanText = priceText.trim();

      // Handle "Free" case
      if (cleanText === "Free" || cleanText === "") {
        return cy.then(() => 0); // Chain properly with cy.then()
      }

      // Handle numeric case
      const numericPrice = parseFloat(cleanText.replace(/[^0-9.]/g, ""));
      const finalPrice = isNaN(numericPrice) ? 0 : numericPrice;
      return cy.then(() => finalPrice); // Chain properly with cy.then()
    });
};

// Select course for team member
const selectCourseForMember = (
  rowIndex,
  memberColumnIndex = PLANNER_CONSTANTS.FIRST_TEAM_MEMBER_COLUMN,
) => {
  cy.get(`#table-row-${rowIndex}`).within(() => {
    cy.get(`[aria-colindex="${memberColumnIndex}"]`).within(() => {
      cy.get('[role="button"]').click();
    });
  });
  cy.wait(PLANNER_CONSTANTS.SELECTION_WAIT);
};

// Verify selection state
const verifySelectionState = (
  rowIndex,
  shouldBeSelected,
  memberColumnIndex = PLANNER_CONSTANTS.FIRST_TEAM_MEMBER_COLUMN,
) => {
  cy.get(`#table-row-${rowIndex}`).within(() => {
    cy.get(`[aria-colindex="${memberColumnIndex}"]`).within(() => {
      if (shouldBeSelected) {
        cy.get(".bg-emerald-400, .plan-cell-selected").should("exist");
      } else {
        cy.get(".border-gray-300, .plan-cell-unselected").should("exist");
      }
    });
  });
};

// Wait for planner ready
const waitForPlannerReady = () => {
  cy.title().should("contain", "Planner");

  cy.get("#planner").should("be.visible");
  cy.get("#monotable").should("be.visible");
  cy.get("#calculator").should("be.visible");

  cy.get("body").then(($body) => {
    if ($body.find("#table-loading-state").length > 0) {
      cy.get("#table-loading-state").should("not.be.visible");
    }
  });
};

// Verify calculator total
const verifyCalculatorTotal = (expectedTotal) => {
  cy.get("#calculator").within(() => {
    cy.get("#total-value").should("contain", expectedTotal.toString());
  });
};

// TEAM MEMBER UTILITIES

// Add team member via UserPlus button
const addTeamMember = () => {
  cy.get("#plan-actions").within(() => {
    cy.get('button[title="Add Team Member"]').click();
  });
  cy.wait(PLANNER_CONSTANTS.TEAM_ACTION_WAIT);
};

// Remove team member via Trash2 button with confirmation handling
const removeTeamMember = (memberName) => {
  // Find the team member in the table header and click delete button
  cy.get('#monotable').within(() => {
    cy.contains(memberName).parent().within(() => {
      cy.get('button[aria-label*="Remove"], button[title*="Remove"]').click();
    });
  });
  
  // Handle confirmation modal
  cy.get('[role="dialog"]').should("be.visible");
  cy.get('[role="dialog"]').within(() => {
    cy.contains("button", "Confirm").click();
  });
  
  cy.wait(PLANNER_CONSTANTS.TEAM_ACTION_WAIT);
};

// Update team member name via click-to-edit
const updateTeamMemberName = (currentName, newName) => {
  // Find and click the team member name to edit
  cy.get('#monotable').within(() => {
    cy.contains(currentName).click();
  });
  
  // Handle the prompt dialog (Note: Cypress can't handle native prompts directly)
  cy.window().then((win) => {
    cy.stub(win, 'prompt').returns(newName);
  });
  
  cy.wait(PLANNER_CONSTANTS.TEAM_ACTION_WAIT);
};

// Get current team member count - simplified approach
const getTeamMemberCount = () => {
  // Count team member instances in the MonoTable
  return cy.get('#monotable').then(($table) => {
    const tableText = $table.text();
    
    // Count known team member patterns
    let count = 0;
    if (tableText.includes("Richard Hendricks")) count++;
    
    // Count additional team members (Team Member 2, 3, etc.)
    for (let i = 2; i <= PLANNER_CONSTANTS.MAX_TEAM_MEMBERS; i++) {
      if (tableText.includes(`Team Member ${i}`)) count++;
    }
    
    return count;
  });
};

// Verify team member exists in table
const verifyTeamMemberExists = (memberName) => {
  cy.get('#monotable').should("contain", memberName);
};

// Verify team member does not exist in table
const verifyTeamMemberNotExists = (memberName) => {
  cy.get('#monotable').should("not.contain", memberName);
};

// Get team member column index by name - simplified
const getTeamMemberColumnIndex = (memberName) => {
  // For now, return a calculated column index based on member order
  // First team member (Richard) = column 10
  // Additional team members increment from there
  
  if (memberName === "Richard Hendricks") {
    return cy.wrap(PLANNER_CONSTANTS.FIRST_TEAM_MEMBER_COLUMN);
  }
  
  // Extract number from "Team Member X" pattern
  const match = memberName.match(/Team Member (\d+)/);
  if (match) {
    const memberNumber = parseInt(match[1]);
    const columnIndex = PLANNER_CONSTANTS.FIRST_TEAM_MEMBER_COLUMN + memberNumber - 1;
    return cy.wrap(columnIndex);
  }
  
  // Fallback to first team member column
  return cy.wrap(PLANNER_CONSTANTS.FIRST_TEAM_MEMBER_COLUMN);
};

// Export only what we need
export {
  PLANNER_CONSTANTS,
  extractPriceFromRow,
  selectCourseForMember,
  verifySelectionState,
  waitForPlannerReady,
  verifyCalculatorTotal,
  // Team member utilities
  addTeamMember,
  removeTeamMember,
  updateTeamMemberName,
  getTeamMemberCount,
  verifyTeamMemberExists,
  verifyTeamMemberNotExists,
  getTeamMemberColumnIndex,
};