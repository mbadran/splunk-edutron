/**
 * Feature: Course Selection in Planner
 * 
 * As a training planner
 * I want to select courses for team members in my training plan
 * So that I can build a comprehensive training curriculum
 */

import {
  PLANNER_CONSTANTS,
  extractPriceFromRow,
} from "../../support/plannerUtils";

const SCENARIO_CONFIG = {
  BASIC_SELECTION_COUNT: 3,
  CALCULATOR_TEST_COUNT: 10,
  FIRST_TEAM_MEMBER_COLUMN: 10,
};

describe("Feature: Course Selection in Planner", () => {
  
  // Background: Setup planner with initial team member
  beforeEach("Background: Setup planner for course selection", () => {
    // Given I am on the planner page and it has loaded
    cy.visitPlannerAndWait();
  });

  it("Scenario: Selecting courses provides visual feedback", () => {
    // Given the calculator starts at zero
    cy.get("#calculator #total-value").should("contain", "0");

    // When I select multiple courses for the initial team member
    for (let i = 1; i <= SCENARIO_CONFIG.BASIC_SELECTION_COUNT; i++) {
      // Then each course row should be visible
      cy.get(`#table-row-${i}`).should("be.visible");

      // And it should start in an unselected state
      cy.verifySelectionState(i, false, SCENARIO_CONFIG.FIRST_TEAM_MEMBER_COLUMN);

      // When I click to select the course
      cy.selectCourseForMember(i, SCENARIO_CONFIG.FIRST_TEAM_MEMBER_COLUMN);

      // Then it should show as selected
      cy.verifySelectionState(i, true, SCENARIO_CONFIG.FIRST_TEAM_MEMBER_COLUMN);
    }

    cy.log(`âœ… Successfully selected ${SCENARIO_CONFIG.BASIC_SELECTION_COUNT} courses with proper visual feedback`);
  });

  it("Scenario: Calculator updates with accurate totals", () => {
    // Given I want to test calculator accuracy with multiple courses
    cy.log(`ðŸ“Š Testing calculator accuracy with ${SCENARIO_CONFIG.CALCULATOR_TEST_COUNT} courses...`);
    
    // When I select courses and track running totals
    let runningTotal = 0;
    let chain = cy.wrap(null);
    
    for (let i = 1; i <= SCENARIO_CONFIG.CALCULATOR_TEST_COUNT; i++) {
      chain = chain.then(() => {
        // When I get the price for this course
        return extractPriceFromRow(i).then((price) => {
          return cy.log(`Course ${i} Price: ${price}`).then(() => {
            // And add it to my running total
            runningTotal += price;
            
            // And select the course
            cy.selectCourseForMember(i, SCENARIO_CONFIG.FIRST_TEAM_MEMBER_COLUMN);
            cy.wait(PLANNER_CONSTANTS.CALCULATOR_WAIT);
            
            // Then the calculator should show the correct running total
            return cy.get("#calculator #total-value")
              .invoke('text')
              .then((actualText) => {
                const actualAmount = parseInt(actualText.trim());
                
                return cy.log(`Selection ${i}: Expected ${runningTotal}, got ${actualAmount}`).then(() => {
                  expect(actualAmount).to.equal(runningTotal);
                });
              });
          });
        });
      });
    }
    
    // And all courses should remain selected
    chain.then(() => {
      for (let i = 1; i <= SCENARIO_CONFIG.CALCULATOR_TEST_COUNT; i++) {
        cy.verifySelectionState(i, true, SCENARIO_CONFIG.FIRST_TEAM_MEMBER_COLUMN);
      }
      
      cy.log(`âœ… Calculator accurately tracked ${SCENARIO_CONFIG.CALCULATOR_TEST_COUNT} course selections with total: ${runningTotal}`);
    });
  });
});SELECTION_COUNT} courses with proper visual feedback`);
  });

  it("Scenario: Calculator updates with accurate totals", () => {
    // Given I want to test calculator accuracy with multiple courses
    cy.log(`ðŸ“Š Testing calculator accuracy with ${SCENARIO_CONFIG.CALCULATOR_TEST_COUNT} courses...`);
    
    // When I select courses and track running totals
    let runningTotal = 0;
    let chain = cy.wrap(null);
    
    for (let i = 1; i <= SCENARIO_CONFIG.CALCULATOR_TEST_COUNT; i++) {
      chain = chain.then(() => {
        // When I get the price for this course
        return extractPriceFromRow(i).then((price) => {
          return cy.log(`Course ${i} Price: ${price}`).then(() => {
            // And add it to my running total
            runningTotal += price;
            
            // And select the course
            selectCourseForMember(i, SCENARIO_CONFIG.FIRST_TEAM_MEMBER_COLUMN);
            cy.wait(PLANNER_CONSTANTS.CALCULATOR_WAIT);
            
            // Then the calculator should show the correct running total
            return cy.get("#calculator #total-value")
              .invoke('text')
              .then((actualText) => {
                const actualAmount = parseInt(actualText.trim());
                
                return cy.log(`Selection ${i}: Expected ${runningTotal}, got ${actualAmount}`).then(() => {
                  expect(actualAmount).to.equal(runningTotal);
                });
              });
          });
        });
      });
    }
    
    // And all courses should remain selected
    chain.then(() => {
      for (let i = 1; i <= SCENARIO_CONFIG.CALCULATOR_TEST_COUNT; i++) {
        verifySelectionState(i, true, SCENARIO_CONFIG.FIRST_TEAM_MEMBER_COLUMN);
      }
      
      cy.log(`âœ… Calculator accurately tracked ${SCENARIO_CONFIG.CALCULATOR_TEST_COUNT} course selections with total: ${runningTotal}`);
    });
  });
});