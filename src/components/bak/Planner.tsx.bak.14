import React, { useRef, useEffect } from "react";
import { useAtom } from "jotai";
import Header from "./common/header/Header";
import MonoTable from "./MonoTable";
import { Person } from "@/types/types";
import { DEFAULT_TEAM_NAMES } from "@/utils/constants";
import {
  planStateAtom,
  updatePlanStateAtom,
  planTotalAtom,
  planSelectedCoursesAtom,
  planCostPerMemberAtom,
  plannerCoursesAtom,
  setStatusAtom,
  tableScrollRefAtom,
  undoAtom,
  redoAtom,
  canUndoAtom,
  canRedoAtom,
} from "@/atoms/globalAtoms";
import { useCatalogs } from "@/hooks/useCatalogs";
import { exportPlanAsJSON } from "@/utils/planner/exportUtils";

interface PlannerProps {
  onBackToHome: () => void;
}

const Planner: React.FC<PlannerProps> = ({ onBackToHome }) => {
  // Ensure catalogs are loaded at the Planner level
  const { loading: catalogsLoading } = useCatalogs();

  // Table scroll reference for scroll-to-top functionality
  const tableRef = useRef<{ scrollToOffset: (offset: number) => void }>(null);
  const [, setTableScrollRef] = useAtom(tableScrollRefAtom);

  // Set table reference in global atom for use by action buttons
  useEffect(() => {
    setTableScrollRef(tableRef.current);
  }, [setTableScrollRef]);

  // Jotai state management - pure atoms, no local state
  const [planState] = useAtom(planStateAtom);
  const [, updatePlanState] = useAtom(updatePlanStateAtom);
  const [courses] = useAtom(plannerCoursesAtom);
  const [total] = useAtom(planTotalAtom);
  const [selectedCoursesCount] = useAtom(planSelectedCoursesAtom);
  const [costPerMember] = useAtom(planCostPerMemberAtom);
  const [, setStatus] = useAtom(setStatusAtom);

  // History atoms
  const [, undo] = useAtom(undoAtom);
  const [, redo] = useAtom(redoAtom);
  const [canUndo] = useAtom(canUndoAtom);
  const [canRedo] = useAtom(canRedoAtom);

  // Initialize with default team member if empty
  useEffect(() => {
    if (planState.teamMembers.length === 0) {
      setStatus({ isWorking: true, message: "Initializing team..." });

      const defaultMember: Person = {
        id: `member-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        name: DEFAULT_TEAM_NAMES[0],
        email: "",
        role: "",
        teamId: planState.teams[0] || "team-default",
      };
      updatePlanState({ teamMembers: [defaultMember] });
    }
  }, [
    planState.teamMembers.length,
    planState.teams,
    updatePlanState,
    setStatus,
  ]);

  // Debug logging to track data flow
  useEffect(() => {
    console.log("Planner - courses available:", courses?.length || 0);
    console.log("Planner - team members:", planState.teamMembers?.length || 0);
    console.log("Planner - total cost:", total);
    console.log("Planner - selected courses:", selectedCoursesCount);
    console.log("Planner - can undo:", canUndo);
    console.log("Planner - can redo:", canRedo);
  }, [
    courses,
    planState.teamMembers,
    total,
    selectedCoursesCount,
    canUndo,
    canRedo,
  ]);

  // Handler functions
  const handleUndo = () => {
    undo();
  };

  const handleRedo = () => {
    redo();
  };

  const handleExportJSON = () => {
    setStatus({ isWorking: true, message: "Exporting Plan..." });

    try {
      exportPlanAsJSON(planState, selectedCoursesCount, total, costPerMember);

      setStatus({ isWorking: false, message: "Plan exported successfully!" });

      // Clear success message after delay
      setTimeout(() => {
        setStatus({ isWorking: false, message: "" });
      }, 2000);
    } catch (error) {
      console.error("Export failed:", error);
      setStatus({ isWorking: false, message: "Export failed" });
    }
  };

  const handleBudgetChange = (newBudget: number | null) => {
    setStatus({ isWorking: true, message: "Updating plan budget..." });
    updatePlanState({ budget: newBudget });
  };

  // Navigation handler
  const handleNavigate = (route: string) => {
    setStatus({ isWorking: true, message: `Navigating to ${route}...` });
    console.log("Navigate to:", route);
    // TODO: Implement navigation logic when routing is added
    setTimeout(() => setStatus({ isWorking: false, message: "" }), 1000);
  };

  return (
    <div id="planner" className="min-h-screen bg-gray-50 flex flex-col">
      <Header
        onBackToHome={onBackToHome}
        pageTitle={planState.title}
        onUndo={handleUndo}
        onRedo={handleRedo}
        onExportJSON={handleExportJSON}
        canUndo={canUndo}
        canRedo={canRedo}
        total={total}
        onBudgetChange={handleBudgetChange}
        currentRoute="/planner"
        onNavigate={handleNavigate}
      />

      {/* MonoTable replaces the dual-table PlanScroller - full height minus header */}
      <div className="flex-1 min-h-0 p-4">
        <div className="h-full">
          <MonoTable ref={tableRef} />
        </div>
      </div>
    </div>
  );
};

export default Planner;
