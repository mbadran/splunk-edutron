import React from "react";
import { useAtom } from "jotai";
import { atomWithStorage } from "jotai/utils";
import Header from "@/components/common/Header";
import PlanScroller from "./PlanScroller";
import { Course } from "@/types/types";
import { DEFAULT_PLAN_TITLE, DEFAULT_TEAM_NAMES } from "@/utils/constants";

// Global Jotai atoms for plan state
export const planTitleAtom = atomWithStorage("plan-title", DEFAULT_PLAN_TITLE);
export const planTeamMembersAtom = atomWithStorage("plan-team-members", [DEFAULT_TEAM_NAMES[0]]);
export const planSelectionsAtom = atomWithStorage("plan-selections", {} as Record<string, boolean>);
export const planCoursesAtom = atomWithStorage("plan-courses", [] as Course[]);
export const planBudgetAtom = atomWithStorage("plan-budget", null as number | null);

// Derived atom for total calculation
export const planTotalAtom = atom((get) => {
  const courses = get(planCoursesAtom);
  const teamMembers = get(planTeamMembersAtom);
  const selections = get(planSelectionsAtom);
  
  return courses.reduce((acc, course, courseIndex) => {
    const memberSelections = teamMembers.reduce((memberAcc, _, memberIndex) => {
      const key = `${courseIndex}-${memberIndex}`;
      return memberAcc + (selections[key] ? course.Price : 0);
    }, 0);
    return acc + memberSelections;
  }, 0);
});

// Undo/Redo state atoms
export const planHistoryAtom = atomWithStorage("plan-history", [] as any[]);
export const planHistoryIndexAtom = atomWithStorage("plan-history-index", -1);

interface PlannerProps {
  onBackToHome: () => void;
}

const Planner: React.FC<PlannerProps> = ({ onBackToHome }) => {
  // Jotai state management
  const [planTitle, setPlanTitle] = useAtom(planTitleAtom);
  const [teamMembers, setTeamMembers] = useAtom(planTeamMembersAtom);
  const [selections, setSelections] = useAtom(planSelectionsAtom);
  const [courses, setCourses] = useAtom(planCoursesAtom);
  const [budget, setBudget] = useAtom(planBudgetAtom);
  const [total] = useAtom(planTotalAtom);
  const [history, setHistory] = useAtom(planHistoryAtom);
  const [historyIndex, setHistoryIndex] = useAtom(planHistoryIndexAtom);

  // Handler functions (no useCallback needed with Jotai)
  const handleUpdateTitle = (newTitle: string) => {
    setPlanTitle(newTitle);
    saveToHistory();
  };

  const saveToHistory = () => {
    const currentState = {
      title: planTitle,
      teamMembers,
      selections,
      courses,
      budget,
      timestamp: Date.now()
    };
    
    const newHistory = history.slice(0, historyIndex + 1);
    newHistory.push(currentState);
    
    // Keep only last 50 states
    if (newHistory.length > 50) {
      newHistory.shift();
    } else {
      setHistoryIndex(historyIndex + 1);
    }
    
    setHistory(newHistory);
  };

  const handleUndo = () => {
    if (historyIndex > 0) {
      const previousState = history[historyIndex - 1];
      setPlanTitle(previousState.title);
      setTeamMembers(previousState.teamMembers);
      setSelections(previousState.selections);
      setCourses(previousState.courses);
      setBudget(previousState.budget);
      setHistoryIndex(historyIndex - 1);
    }
  };

  const handleRedo = () => {
    if (historyIndex < history.length - 1) {
      const nextState = history[historyIndex + 1];
      setPlanTitle(nextState.title);
      setTeamMembers(nextState.teamMembers);
      setSelections(nextState.selections);
      setCourses(nextState.courses);
      setBudget(nextState.budget);
      setHistoryIndex(historyIndex + 1);
    }
  };

  const handleDownload = () => {
    const planData = {
      title: planTitle,
      teamMembers,
      selections,
      courses,
      budget,
      total,
      exportDate: new Date().toISOString(),
      version: "1.0"
    };

    const dataStr = JSON.stringify(planData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `${planTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_plan.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  };

  const handleTeamMembersChange = (newTeamMembers: string[]) => {
    setTeamMembers(newTeamMembers);
    saveToHistory();
  };

  const handleSelectionsChange = (newSelections: Record<string, boolean>) => {
    setSelections(newSelections);
    saveToHistory();
  };

  const handleBudgetChange = (newBudget: number | null) => {
    setBudget(newBudget);
  };

  const handleCoursesChange = (newCourses: Course[]) => {
    setCourses(newCourses);
    saveToHistory();
  };

  // Navigation handler
  const handleNavigate = (route: string) => {
    console.log("Navigate to:", route);
    // TODO: Implement navigation logic when routing is added
  };

  return (
    <div id="planner" className="min-h-screen bg-gray-50 flex flex-col">
      <Header
        onBackToHome={onBackToHome}
        pageTitle={planTitle}
        onUpdateTitle={handleUpdateTitle}
        onUndo={handleUndo}
        onRedo={handleRedo}
        onDownload={handleDownload}
        canUndo={historyIndex > 0}
        canRedo={historyIndex < history.length - 1}
        total={total}
        onBudgetChange={handleBudgetChange}
        currentRoute="/planner"
        onNavigate={handleNavigate}
      />

      <PlanScroller
        courses={courses}
        teamMembers={teamMembers}
        selections={selections}
        onTeamMembersChange={handleTeamMembersChange}
        onSelectionsChange={handleSelectionsChange}
        onCoursesChange={handleCoursesChange}
      />
    </div>
  );
};

export default Planner;