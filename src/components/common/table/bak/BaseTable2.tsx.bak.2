import React from "react";
import { Table, flexRender } from "@tanstack/react-table";

// Re-export components and utilities for backward compatibility
export { TableHeader } from "./TableHeader";
export { DefaultCell, RowNumberCell } from "./cellrenderers";
export { createColumn, createRowNumberColumn } from "@/utils/table/columnUtils";
export type { CellRenderer } from "./cellrenderers";
export type { BaseColumnConfig } from "@/utils/table/columnUtils";

// Forward ref interface for BaseTable2
export interface BaseTable2Ref {
  scrollToTop: () => void;
}

interface BaseTable2Props<TData> {
  table: Table<TData>;
  onScroll?: (scrollTop: number) => void;
  containerHeight?: number | string;
  headerClassName?: string;
  bodyClassName?: string;
  rowClassName?: string;
  cellClassName?: string;
  emptyStateMessage?: string;
  loadingState?: boolean;
  footerMessage?: string;
  enableAlternatingRows?: boolean;
  enableColumnAlternation?: boolean;
  teamColumnStartIndex?: number;
}

const BaseTable2 = React.forwardRef<BaseTable2Ref, BaseTable2Props<any>>(
  <TData,>(
    {
      table,
      onScroll,
      containerHeight = "100%",
      headerClassName = "",
      bodyClassName = "",
      rowClassName = "",
      cellClassName = "",
      emptyStateMessage = "No data available",
      loadingState = false,
      footerMessage,
      enableAlternatingRows = true,
      enableColumnAlternation = false,
      teamColumnStartIndex,
    }: BaseTable2Props<TData>,
    ref: React.Ref<BaseTable2Ref>,
  ) => {
    const scrollRef = React.useRef<HTMLDivElement>(null);

    React.useImperativeHandle(ref, () => ({
      scrollToTop: () => {
        if (scrollRef.current) {
          scrollRef.current.scrollTop = 0;
        }
      },
    }));

    const handleScroll = (e: React.UIEvent<HTMLDivElement>) => {
      const newScrollTop = e.currentTarget.scrollTop;
      if (onScroll) {
        onScroll(newScrollTop);
      }
    };

    const rows = table.getRowModel().rows;
    const headerGroups = table.getHeaderGroups();
    const totalWidth = table.getTotalSize();

    // Get row background color
    const getRowClassName = (rowIndex: number) => {
      let classes = `flex ${rowClassName} hover:bg-orange-50 transition-colors duration-150`;
      
      if (enableAlternatingRows) {
        classes += rowIndex % 2 === 0 ? " bg-white" : " bg-gray-50";
      }
      
      return classes;
    };

    // Get cell background color for column alternation (team columns)
    const getCellClassName = (cellIndex: number, columnId: string) => {
      let classes = `overflow-hidden ${cellClassName}`;
      
      if (enableColumnAlternation && teamColumnStartIndex !== undefined) {
        const isTeamColumn = cellIndex >= teamColumnStartIndex;
        const teamColumnIndex = cellIndex - teamColumnStartIndex;
        
        if (isTeamColumn && teamColumnIndex % 2 === 1) {
          classes += " bg-gray-100/50";
        }
      }
      
      return classes;
    };

    const renderEmptyState = () => (
      <div className="flex items-center justify-center h-32">
        <div className="text-center">
          <div className="text-gray-400 mb-2">
            <svg className="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <p className="text-gray-500 font-medium">{emptyStateMessage}</p>
        </div>
      </div>
    );

    const renderLoadingState = () => (
      <div className="flex items-center justify-center h-32">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto mb-3"></div>
          <p className="text-gray-500 font-medium">Loading...</p>
        </div>
      </div>
    );

    return (
      <div
        className="flex flex-col h-full bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden"
        style={{ height: containerHeight }}
      >
        {/* Enhanced Header */}
        <div
          className={`${headerClassName} border-b border-gray-300`}
          style={{ minWidth: totalWidth }}
        >
          {headerGroups.map((headerGroup) => (
            <div key={headerGroup.id} className="flex">
              {headerGroup.headers.map((header) => (
                <div
                  key={header.id}
                  className="relative border-r border-gray-400 last:border-r-0"
                  style={{
                    width: header.getSize(),
                    minWidth: header.getSize(),
                  }}
                >
                  <div className="h-20 flex items-center">
                    {header.isPlaceholder ? null : (
                      flexRender(
                        header.column.columnDef.header,
                        header.getContext(),
                      )
                    )}
                  </div>
                  
                  {/* Enhanced Native TanStack Resizer */}
                  {header.column.getCanResize() && (
                    <div
                      className={`absolute right-0 top-0 h-full w-1 cursor-col-resize transition-all duration-200 ${
                        header.column.getIsResizing()
                          ? "bg-orange-500 opacity-100 w-2"
                          : "bg-gray-400 opacity-0 hover:opacity-60"
                      }`}
                      onMouseDown={header.getResizeHandler()}
                      onTouchStart={header.getResizeHandler()}
                      role="separator"
                      aria-label="Resize column"
                      tabIndex={0}
                    />
                  )}
                </div>
              ))}
            </div>
          ))}
        </div>

        {/* Enhanced Scrollable Body */}
        <div className="flex-1 overflow-auto">
          <div
            ref={scrollRef}
            className={`${bodyClassName}`}
            style={{ minWidth: totalWidth }}
            onScroll={handleScroll}
            role="grid"
            aria-label="Data table"
            aria-rowcount={rows.length}
            aria-colcount={table.getAllColumns().length}
          >
            {loadingState
              ? renderLoadingState()
              : rows.length === 0
                ? renderEmptyState()
                : rows.map((row, rowIndex) => (
                    <div
                      key={row.id}
                      className={getRowClassName(rowIndex)}
                      role="row"
                      aria-rowindex={rowIndex + 2}
                    >
                      {row.getVisibleCells().map((cell, cellIndex) => (
                        <div
                          key={cell.id}
                          className={getCellClassName(cellIndex, cell.column.id)}
                          style={{
                            width: cell.column.getSize(),
                            minWidth: cell.column.getSize(),
                          }}
                          role="gridcell"
                          aria-colindex={cellIndex + 1}
                        >
                          {flexRender(
                            cell.column.columnDef.cell,
                            cell.getContext(),
                          )}
                        </div>
                      ))}
                    </div>
                  ))}
          </div>
        </div>

        {/* Enhanced Footer */}
        {footerMessage && (
          <div className="flex-shrink-0 px-4 py-3 bg-gray-50 border-t border-gray-200">
            <span 
              className="text-gray-700 text-sm font-medium"
              dangerouslySetInnerHTML={{
                __html: footerMessage
                  .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-gray-900">$1</strong>')
              }}
            />
          </div>
        )}
      </div>
    );
  },
);

BaseTable2.displayName = "BaseTable2";

export default BaseTable2;