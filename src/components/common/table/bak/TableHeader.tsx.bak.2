import React from "react";
import {
  ArrowUpDown,
  ArrowUp,
  ArrowDown,
  Filter,
  GripVertical,
} from "lucide-react";
import { Column } from "@tanstack/react-table";
import { TABLE_DEFAULTS } from "@/utils/constants";

// Table header component with filtering and sorting controls
export const TableHeader = <TData,>({
  column,
  children,
  className = "",
  showMoveHandle = false,
  onMoveColumn,
}: {
  column: Column<TData, unknown>;
  children: React.ReactNode;
  className?: string;
  showMoveHandle?: boolean;
  onMoveColumn?: (columnId: string, direction: "left" | "right") => void;
}) => {
  const canSort = column.getCanSort();
  const sortDirection = column.getIsSorted();
  const canFilter = column.getCanFilter();
  const filterValue = column.getFilterValue();
  const hasFilter = filterValue !== undefined && filterValue !== "";
  const isSorted = sortDirection !== false;

  const [showFilterInput, setShowFilterInput] = React.useState(false);
  const [inputValue, setInputValue] = React.useState(
    (filterValue ?? "") as string,
  );
  const [debounceTimer, setDebounceTimer] =
    React.useState<NodeJS.Timeout | null>(null);

  // Sync input value with filter value when filter changes externally
  React.useEffect(() => {
    setInputValue((filterValue ?? "") as string);
  }, [filterValue]);

  // Debounced filtering with configurable delay
  const handleFilterChange = React.useCallback(
    (value: string) => {
      setInputValue(value);

      // Clear existing timer
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }

      // Set new debounced timer using constant
      const newTimer = setTimeout(() => {
        column.setFilterValue(value || undefined);
      }, TABLE_DEFAULTS.FILTER_DEBOUNCE_MS);

      setDebounceTimer(newTimer);
    },
    [column, debounceTimer],
  );

  // Cleanup timer on unmount
  React.useEffect(() => {
    return () => {
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }
    };
  }, [debounceTimer]);

  // Determine header text color based on active states
  const getHeaderTextColor = () => {
    if (hasFilter || isSorted) return "text-orange-400";
    return "text-white";
  };

  // Drag and drop handlers for column reordering
  const handleDragStart = (e: React.DragEvent) => {
    e.stopPropagation();
    e.dataTransfer.setData("text/plain", column.id);
    e.dataTransfer.effectAllowed = "move";
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    const draggedColumnId = e.dataTransfer.getData("text/plain");
    if (draggedColumnId && draggedColumnId !== column.id && onMoveColumn) {
      const rect = e.currentTarget.getBoundingClientRect();
      const dragX = e.clientX - rect.left;
      const isLeftDrop = dragX < rect.width / 2;
      onMoveColumn(draggedColumnId, isLeftDrop ? "left" : "right");
    }
  };

  return (
    <div className={`w-full ${className}`}>
      {/* Row 1: Column Title - LEFT ALIGNED */}
      <div
        className={`flex items-center justify-start w-full text-sm font-semibold h-8 px-2 ${getHeaderTextColor()}`}
      >
        <span className="truncate">{children}</span>
      </div>

      {/* Row 2: Controls OR Filter Input */}
      <div className="flex items-center justify-start w-full h-6 px-2">
        {showFilterInput && canFilter ? (
          /* Filter Input Row */
          <input
            type="text"
            value={inputValue}
            onChange={(e) => {
              e.stopPropagation();
              handleFilterChange(e.target.value);
            }}
            onBlur={() => setShowFilterInput(false)}
            onKeyDown={(e) => {
              e.stopPropagation();
              if (e.key === "Escape") {
                setShowFilterInput(false);
              }
              if (e.key === "Enter") {
                setShowFilterInput(false);
              }
            }}
            placeholder={`Filter ${children}...`}
            className="w-full mx-1 px-2 py-1 text-xs text-white bg-transparent border-2 border-orange-400 rounded outline-none placeholder-white placeholder-opacity-70 italic font-normal"
            autoFocus
          />
        ) : (
          /* Controls Row */
          <div className="flex items-center gap-1">
            {/* Move Handle */}
            {showMoveHandle && onMoveColumn && (
              <div
                className="cursor-grab hover:cursor-grab active:cursor-grabbing opacity-50 hover:opacity-100 hover:text-orange-300 transition-all"
                title="Drag to reorder column"
                draggable={true}
                onDragStart={handleDragStart}
                onDragOver={handleDragOver}
                onDrop={handleDrop}
              >
                <GripVertical className="w-3 h-3" />
              </div>
            )}

            {/* Sort Button */}
            {canSort && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  column.toggleSorting();
                }}
                className={`opacity-50 hover:opacity-100 transition-opacity hover:text-orange-300 ${
                  isSorted ? "text-orange-400 opacity-100" : ""
                }`}
                title={`Sort by ${children}`}
                type="button"
              >
                {sortDirection === "asc" ? (
                  <ArrowUp className="w-3 h-3" />
                ) : sortDirection === "desc" ? (
                  <ArrowDown className="w-3 h-3" />
                ) : (
                  <ArrowUpDown className="w-3 h-3" />
                )}
              </button>
            )}

            {/* Filter Toggle */}
            {canFilter && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  setShowFilterInput(true);
                }}
                className={`opacity-50 hover:opacity-100 transition-opacity hover:text-orange-300 ${
                  hasFilter ? "text-orange-400 opacity-100" : ""
                }`}
                title="Toggle filter"
                type="button"
              >
                <Filter className="w-3 h-3" />
              </button>
            )}
          </div>
        )}
      </div>
    </div>
  );
};
