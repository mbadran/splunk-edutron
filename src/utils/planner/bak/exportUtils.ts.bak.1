import { Plan, PlanState, Course } from "@/types/types";

/**
 * Generates filename for plan export with format: edutron_YYYY-MM-DD-HH-MM_plan-title-with-hyphens.json
 */
export const generateExportFilename = (planTitle: string, extension: string = 'json'): string => {
  const now = new Date();
  const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
  
  // Get local time in HH-MM format (24-hour)
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  const timeStr = `${hours}-${minutes}`;
  
  // Clean plan title: replace spaces with hyphens, remove special chars
  const cleanTitle = planTitle
    .toLowerCase()
    .replace(/\s+/g, '-')           // Replace spaces with hyphens
    .replace(/[^a-z0-9-]/g, '')     // Remove special characters except hyphens
    .replace(/-+/g, '-')            // Replace multiple consecutive hyphens with single
    .replace(/^-|-$/g, '');         // Remove leading/trailing hyphens
  
  return `edutron_${dateStr}-${timeStr}_${cleanTitle}.${extension}`;
};

/**
 * Exports plan data as JSON file with enhanced metadata
 */
export const exportPlanAsJSON = (
  planState: PlanState,
  selectedCoursesCount: number,
  totalCost: number,
  costPerMember: Record<string, number>
): void => {
  const planExport: Plan = {
    metadata: {
      id: planState.id,
      title: planState.title,
      version: "1.0",
      createdAt: planState.createdAt,
      updatedAt: planState.updatedAt,
      exportedAt: new Date().toISOString(),
    },
    state: planState,
    totals: {
      selectedCourses: selectedCoursesCount,
      totalCost: totalCost,
      costPerMember: costPerMember,
    },
    courses: [], // Remove courses array - keep lean for import/export
  };

  const dataStr = JSON.stringify(planExport, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const filename = generateExportFilename(planState.title, 'json');

  const linkElement = document.createElement("a");
  linkElement.setAttribute("href", url);
  linkElement.setAttribute("download", filename);
  linkElement.click();
  
  // Clean up the blob URL
  URL.revokeObjectURL(url);
};